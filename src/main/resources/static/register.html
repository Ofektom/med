<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EMR Register Super Admin</title>
    <link rel="icon" type="image/x-icon" href="/includes/images/favicon.ico">
    <link rel="stylesheet" href="/assets/css/bootstrap-icons.css">
    <link rel="stylesheet" href="/assets/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="/assets/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/assets/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/bootstrap.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>

<body>
    <div id="preloader"></div>
    <div class="row px-0 mx-0">
        <div class="col-lg-6 bg-dark-primary min-vh-100 d-flex align-items-center justify-content-center auth-logo-main">
            <div class="auth-logo d-flex flex-column align-items-center">
                <img src="/includes/images/mainlogo.png" alt="" class="mb-4 auth-logo-img w-100">
                <img src="/includes/images/login-main.svg" alt="" class="w-100 auth-logo-doctor">
            </div>
        </div>
        <div class="col-lg-6">
            <div class="row align-items-center h-100 justify-content-center py-3 py-lg-0">
                <div class="bg-white p-4 shadow rounded-10 col-sm-10 col-xxl-8 auth-form">
                    <h4 class="text-dark fw-600 mb-4">Super Admin Registration</h4>
                    <span class="text-gray">Register to onboard as a Super Admin</span>
                    <div class="text-center py-3">
                        <button class="btn btn-outline-dark w-100 p-1 d-flex align-items-center justify-content-center">
                            <img src="/includes/images/googlelogo.svg" alt=""> Continue with Google
                        </button>
                    </div>
                    <form id="register_form">
                        <div class="mb-3">
                            <label for="firstName" class="text-dark mb-2">First Name <sup><span class="required">*</span></sup></label>
                            <input type="text" id="firstName" name="firstName" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="lastName" class="text-dark mb-2">Last Name <sup><span class="required">*</span></sup></label>
                            <input type="text" id="lastName" name="lastName" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="streetAddress" class="text-dark mb-2">Street Address <sup><span class="required">*</span></sup></label>
                            <input type="text" id="streetAddress" name="streetAddress" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="text-dark mb-2">Email <sup><span class="required">*</span></sup></label>
                            <input type="email" id="email" name="email" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumber" class="text-dark mb-2">Phone Number <sup><span class="required">*</span></sup></label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="text-dark mb-2">Password <sup><span class="required">*</span></sup></label>
                            <input type="password" id="password" name="password" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3">
                            <label for="cnfpass" class="text-dark mb-2">Confirm Password <sup><span class="required">*</span></sup></label>
                            <input type="password" id="cnfpass" name="cnfpass" class="border form-control rounded" required>
                        </div>
                        <div class="mb-3 d-flex">
                            <input type="checkbox" class="form-check me-3" name="checkterms" required checked>
                            <span>I Agree to the <a href="javascript:void(0)" class="text-primary text-decoration-underline fw-600">Terms & Conditions</a> and <a href="javascript:void(0)" class="text-primary text-decoration-underline fw-600">Privacy Policy</a></span>
                        </div>
                        <div class="text-center mb-3">
                            <button type="submit" class="btn btn-primary w-75 mw-120 rounded-pill py-2">Register</button>
                        </div>
                    </form>
                    <div class="mb-3 text-center">
                        Already have an Account? <a href="index.html" class="text-primary text-decoration-underline fw-600">Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/jquery-3.7.0.js"></script>
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/jquery.dataTables.min.js"></script>
    <script src="/assets/js/dataTables.bootstrap5.min.js"></script>
    <script src="/assets/js/dataTables.responsive.min.js"></script>
    <script src="/assets/js/apexcharts.js"></script>
    <script src="/assets/js/bootstrap-datepicker.min.js"></script>
    <script src="/assets/js/jquery.slimscroll.min.js"></script>
    <script src="/assets/js/togglepassword.js"></script>
    <script src="/assets/js/all.min.js"></script>
    <script src="/assets/js/script.js"></script>

    <script>
        $(document).ready(function () {
            console.log("Document ready, setting up form submission handler");

            $('#register_form').submit(function (e) {
                e.preventDefault();
                console.log("Form submitted, preventing default behavior");

                // Validate form fields before submission
                const firstName = $('#firstName').val().trim();
                const lastName = $('#lastName').val().trim();
                const email = $('#email').val().trim();
                const phoneNumber = $('#phoneNumber').val().trim();
                const password = $('#password').val().trim();
                const confirmPassword = $('#cnfpass').val().trim();
                const streetAddress = $('#streetAddress').val().trim();

                console.log("Form values:", { firstName, lastName, email, phoneNumber, password: '***', streetAddress });

                // Client-side validation
                if (firstName.length < 3) {
                    alert('First name must be at least 3 characters.');
                    return;
                }

                if (lastName.length < 3) {
                    alert('Last name must be at least 3 characters.');
                    return;
                }

                if (!email || !email.includes('@')) {
                    alert('Please enter a valid email address.');
                    return;
                }

                if (!phoneNumber) {
                    alert('Phone number is required.');
                    return;
                }

                if (password.length < 8) {
                    alert('Password must be at least 8 characters long.');
                    return;
                }

                // Validate password complexity: at least one uppercase, one lowercase, one digit, one special character
                // This matches the backend regex: ^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@#$%^&+=]).{8,}$
                const passwordRegex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@#$%^&+=]).{8,}$/;
                if (!passwordRegex.test(password)) {
                    alert('Password must contain at least:\n- 8 characters\n- One uppercase letter (A-Z)\n- One lowercase letter (a-z)\n- One digit (0-9)\n- One special character (@#$%^&+=)');
                    return;
                }

                if (password !== confirmPassword) {
                    console.log("Passwords do not match");
                    alert('Passwords do not match.');
                    return;
                }

                if (!streetAddress) {
                    alert('Street address is required.');
                    return;
                }

                // Prepare signup data
                const signupData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phoneNumber: phoneNumber,
                    password: password,
                    streetAddress: streetAddress,
                    userRole: 'ROLE_SUPER_ADMIN'
                };
                console.log("Signup Data prepared:", { ...signupData, password: '***' });

                // Submit without profile picture
                console.log("Sending AJAX request to register endpoint");
                $.ajax({
                    url: '/api/v1/auth/register',
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify(signupData),
                    success: function (response) {
                        console.log("AJAX Success Response:", response);
                        if (response.status_code === 200 || response.status === 'success') {
                            console.log("Registration successful, redirecting to index.html");
                            alert('Super Admin registration successful! Please login.');
                            window.location.href = 'index.html';
                        } else {
                            console.log("Registration failed with message:", response.message);
                            alert('Registration failed: ' + (response.message || 'Unknown error'));
                        }
                    },
                    error: function (xhr, status, error) {
                        // Log everything for debugging
                        console.log("=== AJAX ERROR DEBUG ===");
                        console.log("Status:", xhr.status);
                        console.log("Status Text:", xhr.statusText);
                        console.log("Response Text (raw):", xhr.responseText);
                        console.log("Response JSON (auto-parsed):", xhr.responseJSON);
                        console.log("All Response Headers:", xhr.getAllResponseHeaders());
                        console.log("=========================");
                        
                        let errorMessage = 'Registration failed.';
                        let responseData = null;
                        
                        // Try to parse response as JSON - jQuery should auto-parse if Content-Type is application/json
                        if (xhr.responseJSON) {
                            responseData = xhr.responseJSON;
                            console.log("Using auto-parsed responseJSON:", responseData);
                        } else if (xhr.responseText) {
                            try {
                                responseData = JSON.parse(xhr.responseText);
                                console.log("Manually parsed responseText:", responseData);
                            } catch (e) {
                                console.log("Failed to parse responseText as JSON:", e);
                                console.log("Raw responseText:", xhr.responseText);
                                // If it's not JSON, show the raw text
                                errorMessage = 'Server error: ' + xhr.responseText.substring(0, 500);
                                alert(errorMessage);
                                return;
                            }
                        }
                        
                        // Handle validation errors (422)
                        if (xhr.status === 422) {
                            console.log("422 Validation Error - Processing responseData:", responseData);
                            
                            if (responseData) {
                                // ValidationError structure: { status_code, error, detail: Map<String, String> }
                                if (responseData.detail && typeof responseData.detail === 'object') {
                                    // Validation error with field details
                                    const errors = responseData.detail;
                                    console.log("Found validation errors in detail:", errors);
                                    
                                    const errorList = Object.entries(errors).map(([field, msg]) => {
                                        // Format field names nicely (e.g., "firstName" -> "First Name")
                                        const fieldName = field
                                            .replace(/([A-Z])/g, ' $1')
                                            .replace(/^./, str => str.toUpperCase())
                                            .trim();
                                        return `${fieldName}: ${msg}`;
                                    }).join('\n');
                                    errorMessage = 'Validation errors:\n\n' + errorList;
                                } else if (responseData.error) {
                                    errorMessage = responseData.error;
                                    if (responseData.detail) {
                                        errorMessage += '\n\nDetails: ' + JSON.stringify(responseData.detail, null, 2);
                                    }
                                } else if (responseData.message) {
                                    errorMessage = responseData.message;
                                } else {
                                    // Fallback: show the whole response
                                    errorMessage = 'Validation failed. Response: ' + JSON.stringify(responseData, null, 2);
                                }
                            } else {
                                errorMessage = 'Validation failed (422). No response data received.';
                            }
                        } else if (responseData) {
                            // Handle other error responses
                            if (responseData.message) {
                                errorMessage = responseData.message;
                            } else if (responseData.error) {
                                errorMessage = responseData.error;
                            } else {
                                errorMessage = 'Error: ' + JSON.stringify(responseData, null, 2);
                            }
                        } else if (xhr.responseText) {
                            errorMessage = 'Server error: ' + xhr.responseText.substring(0, 500);
                        }
                        
                        console.log("Final error message to display:", errorMessage);
                        alert(errorMessage);
                    }
                });
            });
        });
    </script>
</body>
</html>